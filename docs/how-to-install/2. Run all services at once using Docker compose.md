# How to run all services using Docker compose

We can use Docker Compose to quickstart all services at once. Before running, we have to build 2 images of FHIR Server and ID Server.

## Building images
```
# Building FHIR Server image
cd fhir-server
docker build -t fhir-server:latest .

# Building ID Server image
cd id-server
docker build -t id-server:latest .
```
We can open 2 terminals to build 2 images at once, we don't have to wait for first image to be completed. The building process will cost about 15 mins

## Setup variables
Before able to run the project, we have to setup some environment variable. Create a `.env` file in `run-all` folder and paste this body

```
# ID Server connect to database
ID_DB_USERNAME=admin_keycloak
ID_DB_PASSWORD=your_secured_password

# ID Server hostname (re-configurate this if you host on different domain)
ID_SERVER_HOST=http://192.168.56.1:8080

# FHIR Server connect to database
FHIR_DB_USERNAME=admin_fhir
FHIR_DB_PASSWORD=your_secured_password

# FHIR Server connect to ID Server (re-configurate the root to be the same with ID_SERVER_HOST)
IDENTITY_SERVER_URL=http://192.168.56.1:8080/realms/fhir-realm
```

You should change the username and password to your preference

## Import ID Server' pre-configurated database

I've packed our database into a `.sql` file to prevent excessive repository growth; now we have to manually import it to database before running. The file is in `run-all/import/id-backup.sql`

Follow the instruction below (replace the `ID_DB_USERNAME` to your variable in `.env` file at previous step):

```
cd run-all
docker compose up id-db -d
# Wait for ~10 secs before running next execution
docker cp import/id-backup.sql run-all-id-db-1:/id-backup.sql
docker exec -it run-all-id-db-1 bash    # Open container's bash

pg_restore -U {{ ID_DB_USERNAME }} -d postgres /id-backup.sql
exit    # Exit back to our terminal
```

## Run the product

After finishing all the setup, now we can run the `docker-compose.yml`. First, `cd` into the `run-all` folder, then use `docker compose up` with `--env-file` as below

```
cd run-all
docker compose up
```

If your machine doesn't have image `postgres:15.4` and `postgres:17` yet, Docker compose will automatically pull it for you.

This will orchestrate both the FHIR Server and ID Server together with proper networking and dependencies configured.