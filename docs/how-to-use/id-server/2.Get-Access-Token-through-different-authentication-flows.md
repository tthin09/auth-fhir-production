# Getting Access Token - Authentication Flows

Our ID Server supports two 2 Authentication Flows for obtaining access tokens: Authorization Code (with PKCE) and Client Credentials.

Scopes are used to grant permissions to specific resources when requesting tokens.

# Supported Authentication Flows

## 1. Authorization Code with PKCE Flow

This flow is user for public clients like web apps and mobile apps for patient. Authorization Code flow is a safety flow for client to save token

### Step 1: Generate code verifier and challenge
You can generate it wherever you want, but the `code_verifier` and `code_challege` is a pair that must be used for Step 2 and 3

```
code_verifier = base64url(random(32))
code_challenge = base64url(sha256(code_verifier))
```

### Step 2: Authorization request

```
GET /realms/fhir-realm/protocol/openid-connect/auth
?response_type=code
&client_id=YOUR_CLIENT_ID
&redirect_uri=YOUR_REDIRECT_URI
&scope=YOUR_SCOPES
&code_challenge=CODE_CHALLENGE
&code_challenge_method=S256
```

This will redirect user to Keycloak's login page, and after user have logged in, Keycloak will redirect user back to `redirect_uri` that we have set in the request.
If you have login successfully, the redirect page will have params:

```
https://redirected-page.com/
?session_state=0a4d1a99-526e-4913-95cc-e848d313090e
&iss=http%3A%2F%2F192.168.56.1%3A8080%2Frealms%2Ffhir-realm
&code=e15791c5-e6c6-4117-93f5-9775b01aed68.0a4d1a99-526e-4913-95cc-e848d313090e.f36c6fd0-b46c-43d5-9413-0e462e191822
```

You can see the `code` in the params. You should design this redirect page to continue request for token with the `code` received above like in **Step 3**.

### Step 3: Exchange code for token

```
POST /realms/fhir-realm/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=authorization_code
&client_id=YOUR_CLIENT_ID
&code=AUTHORIZATION_CODE_RECEIVED_IN_STEP_2
&redirect_uri=YOUR_REDIRECT_URI
&code_verifier=CODE_VERIFIER
```

## 2. Client Credentials Flow

Used for private connection that can be trusted to have `client_secret` like EMR portal:
```
POST /realms/fhir-realm/protocol/openid-connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials
&client_id=YOUR_CLIENT_ID
&client_secret=YOUR_CLIENT_SECRET
&scope=YOUR_SCOPES
```

# Available Scopes

Scopes are used for granting specific permission for specific resources. For example: "Allow to read patient's Encounter resources", "Allow to write patient's Observation resources". The scope will be in format:

`{user_type}/{resource}.{permission}`

| Type | Description | Values |
|----------|----------|----------|
| user_type | Who is requesting this Token | patient <br> system |
| resource | What FHIR resource are we accessing | Patient <br> Encounter <br> Observation <br> ...*more* |
| permission | What permission are we granting (read, write, all) <br> The "write" permission is allowing "create" + "update" | r \| c \| u \| w \| * |

Some example:

- `patient/Patient.r`: Allow patient to read their Patient resource
- `system/Encounter.*`: Allow system all permission on Encounter resource
- `system/*.*`: Allow system with all permission on all resources

# Response Format
```
{
  "access_token": "eyJhbGciOiJSUzI1NiIs...",
  "token_type": "Bearer",
  "refresh_token": "eyJhbGciOiJSUzsDFge...",
  "expires_in": 3600,
  "scope": "launch openid fhirUser offline_access system/*.*"
}
```

The Access Token above is what we used in FHIR Server for access to all resources